<!DOCTYPE html>
<html>
<head>
    <title>P2P Voice Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; }
        #myId { padding: 5px; margin-bottom: 10px; width: 200px; }
        .container { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .call-controls { display: none; margin-top: 10px; }
        .volume-bar { width: 100px; height: 20px; background: #ddd; margin: 10px 0; }
        .volume-fill { height: 100%; background: #4CAF50; width: 0%; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        .notification { background: #f0f0f0; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <div>
        <input type="text" id="nickname" placeholder="Your nickname">
        <div>Your ID: <span id="myId"></span></div>
    </div>

    <div class="container">
        <input type="text" id="friendId" placeholder="Friend's ID">
        <button onclick="startCall()">Connect</button>
    </div>

    <div id="incomingCall" class="notification" style="display: none;">
        Incoming call from: <span id="callerNickname"></span>
        <button onclick="acceptCall()">Accept</button>
        <button onclick="rejectCall()">Reject</button>
    </div>

    <div class="call-controls" id="callControls">
        <div>Connected with: <span id="connectedNickname"></span></div>
        <div class="volume-bar">
            <div class="volume-fill" id="volume"></div>
        </div>
        <button id="muteButton" onclick="toggleMute()">Mute</button>
        <button onclick="endCall()">End Call</button>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        let peer;
        let currentCall;
        let localStream;
        let isMuted = false;
        let audioContext;
        let analyser;
        let myNickname = 'User';

        // Инициализация Peer
        function initializePeer() {
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 3
            });

            peer.on('open', id => {
                document.getElementById('myId').textContent = id;
            });

            peer.on('call', async incomingCall => {
                const callerNickname = incomingCall.metadata.nickname;
                document.getElementById('callerNickname').textContent = callerNickname;
                document.getElementById('incomingCall').style.display = 'block';
                currentCall = incomingCall;
            });

            // Обработка отключения
            peer.on('disconnected', () => {
                endCall();
                alert('Connection lost');
            });
        }

        // Начать звонок
        async function startCall() {
            const friendId = document.getElementById('friendId').value;
            if (!friendId) return alert('Enter friend ID');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupVolumeMeter();
                
                currentCall = peer.call(friendId, localStream, {
                    metadata: { nickname: myNickname }
                });
                
                currentCall.on('stream', remoteStream => handleRemoteStream(remoteStream));
                currentCall.on('close', endCall);
                
                showCallControls();
            } catch (err) {
                console.error('Error starting call:', err);
            }
        }

        // Принять звонок
        async function acceptCall() {
            document.getElementById('incomingCall').style.display = 'none';
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupVolumeMeter();
                currentCall.answer(localStream);
                
                currentCall.on('stream', remoteStream => handleRemoteStream(remoteStream));
                showCallControls(currentCall.metadata.nickname);
            } catch (err) {
                console.error('Error accepting call:', err);
            }
        }

        // Обработка удаленного аудио
        function handleRemoteStream(remoteStream) {
            const remoteAudio = new Audio();
            remoteAudio.srcObject = remoteStream;
            remoteAudio.play();
        }

        // Показать элементы управления звонком
        function showCallControls(nickname) {
            document.getElementById('callControls').style.display = 'block';
            document.getElementById('connectedNickname').textContent = nickname || currentCall.metadata.nickname;
        }

        // Завершить звонок
        function endCall() {
            if (currentCall) currentCall.close();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('callControls').style.display = 'none';
            document.getElementById('incomingCall').style.display = 'none';
            resetVolumeMeter();
        }

        // Отклонить звонок
        function rejectCall() {
            endCall();
            document.getElementById('incomingCall').style.display = 'none';
        }

        // Управление микрофоном
        function toggleMute() {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            document.getElementById('muteButton').textContent = isMuted ? 'Unmute' : 'Mute';
        }

        // Индикатор громкости
        function setupVolumeMeter() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(localStream);
            source.connect(analyser);
            analyser.fftSize = 32;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function updateVolume() {
                analyser.getByteFrequencyData(dataArray);
                const volume = Math.max(...dataArray);
                document.getElementById('volume').style.width = volume + '%';
                requestAnimationFrame(updateVolume);
            }
            updateVolume();
        }

        function resetVolumeMeter() {
            if (audioContext) audioContext.close();
            document.getElementById('volume').style.width = '0%';
        }

        // Обработка ника
        document.getElementById('nickname').addEventListener('input', function(e) {
            myNickname = e.target.value || 'User';
        });

        // Инициализация при загрузке
        window.onload = initializePeer;
    </script>
</body>
</html>
