<!DOCTYPE html>
<html>
<head>
    <title>–ê–Ω–æ–Ω–∏–º–Ω—ã–π –í–æ–π—Å—á–∞—Ç</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            background: #111;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #0f0;
            box-shadow: 0 0 10px #0f0;
            width: 100%;
            max-width: 500px;
            transition: 0.3s;
        }

        .header {
            text-align: center;
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 0 0 5px #0f0;
        }

        .status-box {
            background: #222;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #0f0;
        }

        input, button, select {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #0f0;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            background: #111;
            color: #0f0;
            font-family: 'Courier New', monospace;
        }

        button {
            background: #0f0;
            color: #000;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover {
            background: #0c0;
        }

        .call-controls {
            margin-top: 20px;
            display: none;
        }

        .volume-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .volume-box {
            background: #222;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #0f0;
        }

        .volume-bar {
            width: 100%;
            height: 20px;
            background: #111;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid #0f0;
        }

        .volume-fill {
            height: 100%;
            background: #0f0;
            width: 0%;
            transition: width 0.1s;
        }

        .notification {
            background: #222;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            border: 1px solid #0f0;
        }

        .user-status {
            margin: 10px 0;
            color: #0f0;
            text-align: center;
        }

        .active-call {
            background: #1a1a1a;
        }

        .ping-status {
            margin-top: 5px;
            font-size: 0.9em;
        }

        .volume-slider {
            width: 100%;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="header">–ê–Ω–æ–Ω–∏–º–Ω—ã–π –í–æ–π—Å—á–∞—Ç</div>
        <div class="status-box">
            <input type="text" id="nickname" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
            <div class="user-status">–í–∞—à ID: <strong id="myId">...</strong></div>
            <select id="microphoneSelect"></select>
            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1000" value="100">
            <div class="user-status">–£—Å–∏–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: <span id="volumeValue">100%</span></div>
        </div>

        <div id="connectionPanel">
            <input type="text" id="friendId" placeholder="ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
            <button onclick="startCall()">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
        </div>

        <div class="notification" id="incomingCall">
            <div>üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤ –æ—Ç: <strong id="callerNickname"></strong></div>
            <div style="margin-top:10px;">
                <button onclick="acceptCall()">–ü—Ä–∏–Ω—è—Ç—å</button>
                <button onclick="rejectCall()" style="background:#f00; color:#000;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div class="call-controls" id="callControls">
            <div class="user-status">
                ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å: <strong id="connectedNickname"></strong>
                <div class="ping-status">–ü–∏–Ω–≥: <span id="pingDisplay">0</span>–º—Å</div>
            </div>
            
            <div class="volume-container">
                <div class="volume-box">
                    <div>–í–∞—à –º–∏–∫—Ä–æ—Ñ–æ–Ω</div>
                    <div class="volume-bar">
                        <div class="volume-fill" id="localVolume"></div>
                    </div>
                    <div id="muteStatus">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω</div>
                </div>
                <div class="volume-box">
                    <div>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
                    <div class="volume-bar">
                        <div class="volume-fill" id="remoteVolume"></div>
                    </div>
                    <div id="remoteMuteStatus">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω</div>
                </div>
            </div>

            <div style="display: flex; gap:10px;">
                <button id="muteButton" onclick="toggleMute()">üîá –í—ã–∫–ª—é—á–∏—Ç—å</button>
                <button onclick="endCall()" style="background: #f00; color:#000;">üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        let peer;
        let currentCall;
        let localStream;
        let dataConnection;
        let isMuted = false;
        let audioContext;
        let analyser;
        let myNickname = '–ê–Ω–æ–Ω–∏–º';
        let pingInterval;
        let gainNode;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Peer
        function initializePeer() {
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 3
            });

            peer.on('open', id => {
                document.getElementById('myId').textContent = id;
            });

            peer.on('call', async incomingCall => {
                document.getElementById('mainContainer').classList.add('active-call');
                const callerNickname = incomingCall.metadata.nickname;
                document.getElementById('callerNickname').textContent = callerNickname;
                showElement('incomingCall');
                currentCall = incomingCall;
                
                dataConnection = peer.connect(incomingCall.peer, {
                    metadata: { nickname: myNickname }
                });
                setupDataChannel();
            });

            peer.on('error', err => console.error('–û—à–∏–±–∫–∞ PeerJS:', err));
        }

        // –ù–∞—á–∞—Ç—å –≤—ã–∑–æ–≤
        async function startCall() {
            const friendId = document.getElementById('friendId').value;
            if (!friendId) return alert('–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
            
            try {
                document.getElementById('mainContainer').classList.add('active-call');
                const selectedDeviceId = document.getElementById('microphoneSelect').value;
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined }
                });
                setupAudioAnalyser();
                
                currentCall = peer.call(friendId, localStream, {
                    metadata: { nickname: myNickname }
                });
                
                dataConnection = peer.connect(friendId, {
                    metadata: { nickname: myNickname }
                });
                setupDataChannel();

                currentCall.on('stream', remoteStream => handleRemoteStream(remoteStream));
                currentCall.on('close', () => endCall(true));
                
                showCallControls();
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ: ' + err.message);
                endCall();
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–Ω–∞–ª–∞ –¥–∞–Ω–Ω—ã—Ö
        function setupDataChannel() {
            dataConnection.on('open', () => {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É ping-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                pingInterval = setInterval(() => {
                    dataConnection.send({ type: 'ping', time: Date.now() });
                }, 1000);

                dataConnection.on('data', data => {
                    if (data.type === 'ping') {
                        dataConnection.send({ type: 'pong', time: data.time });
                    }
                    if (data.type === 'pong') {
                        const latency = Date.now() - data.time;
                        updatePingDisplay(latency);
                    }
                    if (data.type === 'volume') {
                        document.getElementById('remoteVolume').style.width = data.value + '%';
                    }
                    if (data.type === 'muteStatus') {
                        document.getElementById('remoteMuteStatus').textContent = 
                            data.value ? 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω' : 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
                    }
                    if (data.type === 'endCall') {
                        endCall(true);
                    }
                });
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∏–Ω–≥–∞
        function updatePingDisplay(latency) {
            const pingElement = document.getElementById('pingDisplay');
            pingElement.textContent = latency;
            
            if (latency <= 109) {
                pingElement.style.color = '#0f0';
            } else if (latency <= 250) {
                pingElement.style.color = '#ff0';
            } else {
                pingElement.style.color = '#f00';
            }
        }

        // –ü—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤
        async function acceptCall() {
            hideElement('incomingCall');
            try {
                const selectedDeviceId = document.getElementById('microphoneSelect').value;
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined }
                });
                setupAudioAnalyser();
                currentCall.answer(localStream);
                
                currentCall.on('stream', remoteStream => handleRemoteStream(remoteStream));
                currentCall.on('close', () => endCall(true));
                showCallControls(currentCall.metadata.nickname);
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –≤—ã–∑–æ–≤–∞: ' + err.message);
                endCall();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ
        function handleRemoteStream(remoteStream) {
            const remoteAudio = new Audio();
            remoteAudio.srcObject = remoteStream;
            remoteAudio.play();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
        function showCallControls(nickname) {
            showElement('callControls');
            document.getElementById('connectedNickname').textContent = nickname || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
            document.getElementById('connectionPanel').style.display = 'none';
        }

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–∑–æ–≤
        function endCall(notifyOther = false) {
            clearInterval(pingInterval);
            if (currentCall) currentCall.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (dataConnection) {
                if (notifyOther) {
                    dataConnection.send({ type: 'endCall' });
                }
                dataConnection.close();
            }
            
            hideElement('callControls');
            hideElement('incomingCall');
            document.getElementById('connectionPanel').style.display = 'block';
            document.getElementById('mainContainer').classList.remove('active-call');
            resetAudioAnalyser();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º
        function toggleMute() {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            document.getElementById('muteStatus').textContent = 
                isMuted ? 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω' : 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
            dataConnection.send({ type: 'muteStatus', value: isMuted });
        }

        // –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        function setupAudioAnalyser() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(localStream);
            gainNode = audioContext.createGain();
            source.connect(gainNode);
            gainNode.connect(analyser);
            analyser.fftSize = 32;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function updateVolume() {
                analyser.getByteFrequencyData(dataArray);
                const volume = Math.max(...dataArray)/2;
                document.getElementById('localVolume').style.width = volume + '%';
                if(dataConnection && dataConnection.open) {
                    dataConnection.send({ type: 'volume', value: volume });
                }
                requestAnimationFrame(updateVolume);
            }
            updateVolume();
        }

        function resetAudioAnalyser() {
            if (audioContext) audioContext.close();
            document.getElementById('localVolume').style.width = '0%';
            document.getElementById('remoteVolume').style.width = '0%';
            document.getElementById('muteStatus').textContent = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
            document.getElementById('remoteMuteStatus').textContent = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤
        async function getMicrophones() {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
            } catch (err) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', err);
            }

            const devices = await navigator.mediaDevices.enumerateDevices();
            const microphones = devices.filter(device => device.kind === 'audioinput');
            const select = document.getElementById('microphoneSelect');
            select.innerHTML = '<option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>';
            microphones.forEach(mic => {
                const option = document.createElement('option');
                option.value = mic.deviceId;
                option.text = mic.label || `–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${select.options.length}`;
                select.appendChild(option);
            });
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–∏–ª–µ–Ω–∏–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        document.getElementById('volumeSlider').addEventListener('input', function(e) {
            const volume = parseInt(e.target.value);
            document.getElementById('volumeValue').textContent = volume + '%';
            if (gainNode) {
                gainNode.gain.value = volume / 100;
            }
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showElement(id) {
            document.getElementById(id).style.display = 'block';
        }

        function hideElement(id) {
            document.getElementById(id).style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∏–∫–∞
        document.getElementById('nickname').addEventListener('input', function(e) {
            myNickname = e.target.value || '–ê–Ω–æ–Ω–∏–º';
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = async () => {
            initializePeer();
            await getMicrophones();
        };
    </script>
</body>
</html>
